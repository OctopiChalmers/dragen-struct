\section{Unified Representation of Constructions}
\label{sec:representation}

% --------------------------------------
% The basic idea
%
This section introduces a unified representation for the different constructions
we might want to consider when generating random values.
%
The key idea of this work is to lift each different source of structural
information to the type level.
%
In this light, we will define a set of different simple ``open'' data types,
each one in charge of representing a single construction.
%
Later, these types can be
\begin{inparaenum}[(i)]
  \item combined in several ways depending on the desired shape of our test data,
\item randomly generated (see Section \ref{sec:generators}), and finally,
\item transformed back to corresponding values of the target data type automatically.
\end{inparaenum}
%
This lifted representation of constructions can be automatically derived from
our source code in compile-time, relieving programmers of the burden of writing
random generators by hand.


% --------------------------------------
% Representing data constructors
%
\paragraph{Representing Data Constructors}
%
The simplest piece of meaningful%
\footnote{We avoid considering $\bot$ as it does not contain any useful
  information.}
%
information we can consider when generating values of an algebraic data type, is
the one given by each one of its data constructors.
%
In this light, the representation of each individual data constructor of the
target data type is simply given by a new data type containing a single
constructor with the same fields as the corresponding one, except for the
recursive fields which are abstracted away using a type parameter.


Recalling our |Html| example, each one of it data constructors can be
represented as follows:

\begin{code}
data Con_Text   r = Con_Text String
data Con_Sing   r = Con_Sing String
data Con_Tag    r = Con_Tag  String r
data Con_Join   r = Con_Join r r
\end{code}



\begin{code}
class Functor f => Algebra f a | f -> a where
  alg :: f a -> a
\end{code}

\begin{code}
instance Algebra Con_Text Html where
  alg (Con_Text x) = Text x

instance Algebra Con_Sing Html where
  alg (Con_Sing x) = Sing x

instance Algebra Con_Tag Html where
  alg (Con_Tag t x) = Tag t x

instance Algebra Con_Join Html where
  alg (Con_Join x y) = Join x y
\end{code}



\begin{code}
data ((f :: * -> *) oplus (g :: * -> *)) a = InL (f a) | InR (g a)
\end{code}


\begin{code}
instance (Algebra f a, Algebra g a)
  => Algebra (f oplus g) a where
  alg (InL f) = alg f
  alg (InR g) = alg g
\end{code}


\begin{code}
  data Fix (f :: * -> *) = Fix { unFix :: (f (Fix f)) }
\end{code}

\begin{code}
eval :: Algebra f a => Fix f -> a
eval = alg . fmap eval . unFix
\end{code}


\begin{code}
data Fun_br     r = Fun_br
data Fun_bold   r = Fun_bold r
data Fun_cat    r = Fun_cat r r
data Fun_list   r = Fun_list [r]
\end{code}

\begin{code}
data Pat_simplify_1 r = Pat_simplify_1 String String
data Pat_simplify_2 r = Pat_simplify_2 String r r
\end{code}

\begin{code}
instance Algebra Fun_br Html where
  alg Fun_br = br

instance Algebra Fun_bold Html where
  alg (Fun_bold x) = bold x

instance Algebra Fun_cat Html where
  alg (Fun_cat x y) = x <+> y

instance Algebra Fun_list Html where
  alg (Fun_list xs) = list xs
\end{code}

\begin{code}
instance Algebra Pat_simplify_1 Html where
  alg (Pat_simplify_1 t1 t2) = Join (Text t1) (Text t2)

instance Algebra Pat_simplify_2 Html where
  alg (Pat_simplify_1 t x y) = Join (Join (Text t) x) y
\end{code}


\begin{code}
data Some (f :: * -> * -> *) (r :: *) = forall (a :: *) dot Some (f a r)
\end{code}

\begin{code}
type family (t :: * -> *) apply (a :: *) :: * -> *  where
  (Some t)      apply  a  = t a
  (f oplus g)   apply  a  = (f apply a) oplus (g apply a)
  (f otimes n)  apply  a  = (f apply a) otimes n
  (Term t)      apply  a  = Term (t apply a)
  t             apply  a  = t
\end{code}

\begin{code}
type family Con (c :: Symbol)             :: * -> *
type family Pat (p :: Symbol) (n :: Nat)  :: * -> *
type family Fun (f :: Symbol)             :: * -> *
\end{code}

\begin{code}
type instance Con "Text"        = Con_Text
type instance Pat "simplify" 1  = Pat_simplify_1
type instance Fun "<+>"         = Fun_cat
\end{code}

Lorem ipsum dolor sit amet, consectetuer adipiscing elit. Donec hendrerit tempor
tellus. Donec pretium posuere tellus. Proin quam nisl, tincidunt et, mattis
eget, convallis nec, purus. Cum sociis natoque penatibus et magnis dis
parturient montes, nascetur ridiculus mus. Nulla posuere. Donec vitae dolor.
Nullam tristique diam non turpis. Cras placerat accumsan nulla. Nullam rutrum.
Nam vestibulum accumsan nisl\cite{godefroid2005dart}.
